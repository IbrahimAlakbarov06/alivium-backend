<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Test Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .login-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .login-section h3 {
            margin-bottom: 15px;
        }

        .login-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .login-section button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .login-section button:hover {
            background: #0056b3;
        }

        .ws-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .ws-status.connected {
            background: #28a745;
            color: white;
        }

        .ws-status.disconnected {
            background: #dc3545;
            color: white;
        }

        .ws-status.connecting {
            background: #ffc107;
            color: #333;
        }

        .user-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 600px;
        }

        .rooms-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .rooms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .rooms-header h2 {
            font-size: 18px;
        }

        .btn-new {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-new:hover {
            background: #218838;
        }

        .room-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .room-item:hover {
            background: #e9ecef;
        }

        .room-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .room-item strong {
            display: block;
            margin-bottom: 4px;
        }

        .room-item small {
            color: #666;
            font-size: 12px;
        }

        .chat-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 18px;
        }

        .chat-header small {
            color: #666;
            display: block;
            margin-top: 4px;
        }

        .btn-close {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-close:hover {
            background: #c82333;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 8px;
        }

        .message.sent .message-bubble {
            background: #007bff;
            color: white;
        }

        .message.received .message-bubble {
            background: #e9ecef;
            color: #333;
        }

        .message-sender {
            font-size: 11px;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.8;
        }

        .message-input {
            padding: 20px;
            border-top: 1px solid #ddd;
        }

        .message-input-row {
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-send {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-send:hover {
            background: #0056b3;
        }

        .btn-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            text-align: center;
        }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .info-box h3 {
            margin-bottom: 10px;
        }

        .info-box ol {
            margin-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .debug-log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .debug-log div {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Chat Test Interface</h1>

    <div class="login-section">
        <h3>Login / Register</h3>
        <input type="email" id="emailInput" placeholder="Email">
        <input type="password" id="passwordInput" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="register()">Register</button>
        <button onclick="testServerConnection()" style="background: #ffc107; color: #333;">Test Server</button>
        <button onclick="connectWebSocket()" style="background: #17a2b8;">WebSocket Baƒülan</button>
        <button onclick="disconnectWebSocket()" style="background: #6c757d;">Disconnect</button>
        <span id="wsStatus" class="ws-status disconnected">Disconnected</span>

        <div id="userInfo" class="user-info" style="display: none;">
            <strong>Logged in as:</strong> <span id="userName"></span>
        </div>

        <div class="debug-log" id="debugLog"></div>
    </div>

    <div class="chat-container">
        <div class="rooms-panel">
            <div class="rooms-header">
                <h2>Chat Otaqlarƒ±</h2>
                <button class="btn-new" onclick="createChatRoom()">+ Yeni</button>
            </div>
            <div id="roomsList"></div>
        </div>

        <div class="chat-panel" id="chatPanel">
            <div class="empty-state">
                <div>
                    <p style="font-size: 24px; margin-bottom: 10px;">üí¨</p>
                    <p>Chat otaƒüƒ± se√ßin</p>
                </div>
            </div>
        </div>
    </div>

    <div class="info-box">
        <h3>Nec…ô istifad…ô olunur:</h3>
        <ol>
            <li>∆èvv…ôlc…ô email v…ô password il…ô login/register olun</li>
            <li>"WebSocket Baƒülan" d√ºym…ôsin…ô basƒ±n</li>
            <li>"+ Yeni" d√ºym…ôsi il…ô yeni chat otaƒüƒ± yaradƒ±n</li>
            <li>Soldakƒ± paneld…ôn chat otaƒüƒ±nƒ± se√ßin</li>
            <li>Saƒü t…ôr…ôfd…ô real-time mesajla≈üƒ±n</li>
        </ol>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    const API_URL = 'http://localhost:8080/api';
    const WS_URL = 'http://localhost:8080/websocket'; // /ws -> /websocket

    let token = null;
    let currentUser = null;
    let chatRooms = [];
    let selectedRoom = null;
    let messages = [];
    let stompClient = null;
    let currentSubscription = null;

    function log(message) {
        const logDiv = document.getElementById('debugLog');
        const time = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${time}] ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
    }

    async function register() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;

        if (!email || !password) {
            alert('Email v…ô password daxil edin!');
            return;
        }

        try {
            log('Qeydiyyat ba≈üladƒ±...');
            const res = await fetch(API_URL + '/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    firstName: 'Test',
                    lastName: 'User',
                    email: email,
                    password: password
                })
            });

            if (res.ok) {
                log('Qeydiyyat uƒüurlu!');
                alert('Qeydiyyat uƒüurlu! ƒ∞ndi login olun.');
            } else {
                const err = await res.text();
                log('Qeydiyyat x…ôtasƒ±: ' + err);
                alert('X…ôta: ' + err);
            }
        } catch (err) {
            log('Qeydiyyat exception: ' + err.message);
            alert('X…ôta: ' + err.message);
        }
    }

    async function login() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;

        if (!email || !password) {
            alert('Email v…ô password daxil edin!');
            return;
        }

        try {
            log('Login ba≈üladƒ±...');
            const res = await fetch(API_URL + '/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: email, password: password})
            });

            const data = await res.json();
            token = data.accessToken;
            currentUser = data.user;

            log('Login uƒüurlu! User ID: ' + currentUser.id);

            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userName').textContent =
                currentUser.firstName + ' ' + currentUser.lastName + ' (' + currentUser.email + ')';

            alert('Login uƒüurlu!');
            loadChatRooms();
        } catch (err) {
            log('Login x…ôtasƒ±: ' + err.message);
            alert('X…ôta: ' + err.message);
        }
    }

    async function testServerConnection() {
        log('Server …ôlaq…ôsi yoxlanƒ±lƒ±r...');
        try {
            const response = await fetch('http://localhost:8080/api/auth/login', {
                method: 'OPTIONS'
            });
            log('‚úì Server …ôlaq…ôsi var (HTTP)');
            return true;
        } catch (err) {
            log('‚úó Server …ôlaq…ô x…ôtasƒ±: ' + err.message);
            log('‚ùå Backend server i≈ül…ômir! Port 8080-d…ô server ba≈ülatƒ±n.');
            alert('X∆èTA: Backend server i≈ül…ômir!\n\nhttp://localhost:8080 √ºnvanƒ±nda server tapƒ±lmadƒ±.\n\nL√ºtf…ôn Spring Boot aplikasiyanƒ±zƒ± ba≈üladƒ±n.');
            return false;
        }
    }

    async function connectWebSocket() {
        if (!token) {
            alert('∆èvv…ôlc…ô login olun!');
            log('WebSocket baƒülantƒ± c…ôhdi: Token yoxdur!');
            return;
        }

        if (stompClient && stompClient.connected) {
            log('WebSocket artƒ±q baƒülƒ±dƒ±r!');
            alert('WebSocket artƒ±q baƒülƒ±dƒ±r!');
            return;
        }

        // ∆èvv…ôlc…ô server …ôlaq…ôsini yoxla
        const serverOk = await testServerConnection();
        if (!serverOk) {
            return;
        }

        try {
            log('WebSocket baƒülantƒ±sƒ± ba≈ülayƒ±r...');
            log('WS URL: ' + WS_URL);
            updateWSStatus('connecting');

            // SockJS options
            const sockjsOptions = {
                transports: ['websocket', 'xhr-streaming', 'xhr-polling']
            };

            const socket = new SockJS(WS_URL, null, sockjsOptions);

            socket.onopen = function() {
                log('‚úì SockJS socket a√ßƒ±ldƒ±');
            };

            socket.onerror = function(err) {
                log('‚úó SockJS x…ôtasƒ±: ' + JSON.stringify(err));
            };

            socket.onclose = function(e) {
                log('SockJS baƒülandƒ±. Kod: ' + e.code + ', S…ôb…ôb: ' + e.reason);
            };

            stompClient = Stomp.over(socket);

            stompClient.debug = function(str) {
                log('STOMP: ' + str);
            };

            const headers = {
                'Authorization': 'Bearer ' + token
            };

            log('STOMP connect √ßaƒüƒ±rƒ±lƒ±r...');
            log('Token: ' + token.substring(0, 20) + '...');

            stompClient.connect(
                headers,
                function(frame) {
                    log('‚úì WebSocket baƒülandƒ±!');
                    log('Frame: ' + JSON.stringify(frame));
                    updateWSStatus('connected');
                    alert('WebSocket baƒülantƒ±sƒ± uƒüurlu!');

                    if (selectedRoom) {
                        log('Se√ßilmi≈ü otaƒüa subscribe olunur: ' + selectedRoom.id);
                        subscribeToRoom(selectedRoom.id);
                    }
                },
                function(error) {
                    log('‚úó WebSocket x…ôtasƒ±: ' + JSON.stringify(error));
                    console.error('WebSocket x…ôtasƒ±:', error);
                    updateWSStatus('disconnected');

                    let errorMsg = 'WebSocket baƒülantƒ± x…ôtasƒ±!\n\n';
                    errorMsg += 'S…ôb…ôbl…ôr:\n';
                    errorMsg += '1. Backend /ws endpoint m√∂vcud deyil\n';
                    errorMsg += '2. CORS konfiqurasiyasƒ± d√ºzg√ºn deyil\n';
                    errorMsg += '3. WebSocket konfiqurasiyasƒ± yoxdur\n';
                    errorMsg += '4. Token d√ºzg√ºn deyil\n\n';
                    errorMsg += 'Console log-a baxƒ±n v…ô backend-i yoxlayƒ±n.';

                    alert(errorMsg);
                }
            );
        } catch (err) {
            log('‚úó WebSocket exception: ' + err.message);
            console.error('WebSocket exception:', err);
            updateWSStatus('disconnected');
            alert('WebSocket x…ôtasƒ±: ' + err.message);
        }
    }

    function disconnectWebSocket() {
        if (stompClient && stompClient.connected) {
            log('WebSocket baƒülantƒ±sƒ± k…ôsilir...');
            stompClient.disconnect(function() {
                log('WebSocket baƒülantƒ±sƒ± k…ôsildi');
                updateWSStatus('disconnected');
            });
            stompClient = null;
            currentSubscription = null;
        } else {
            log('WebSocket baƒülƒ± deyil');
        }
    }

    function updateWSStatus(status) {
        const statusEl = document.getElementById('wsStatus');
        statusEl.className = 'ws-status ' + status;

        if (status === 'connected') {
            statusEl.textContent = 'Connected ‚úì';
        } else if (status === 'connecting') {
            statusEl.textContent = 'Connecting...';
        } else {
            statusEl.textContent = 'Disconnected';
        }
    }

    function subscribeToRoom(roomId) {
        if (!stompClient || !stompClient.connected) {
            log('Subscribe x…ôtasƒ±: STOMP baƒülƒ± deyil');
            return;
        }

        if (currentSubscription) {
            log('∆èvv…ôlki subscription l…ôƒüv edilir');
            currentSubscription.unsubscribe();
        }

        const topic = '/topic/chat-room.' + roomId;  // /topic/chat/ -> /topic/chat-room.
        log('Subscribe olunur: ' + topic);

        try {
            currentSubscription = stompClient.subscribe(topic, function(message) {
                log('üéâ Yeni mesaj alƒ±ndƒ±: ' + message.body);
                const newMsg = JSON.parse(message.body);
                messages.push(newMsg);
                renderMessages();
            });
            log('‚úì Subscribe uƒüurlu!');
        } catch (err) {
            log('‚úó Subscribe x…ôtasƒ±: ' + err.message);
            console.error('Subscribe x…ôtasƒ±:', err);
        }
    }

    async function loadChatRooms() {
        if (!token) return;

        try {
            log('Chat otaqlarƒ± y√ºkl…ônir...');
            const res = await fetch(API_URL + '/chatRooms/my', {
                headers: {'Authorization': 'Bearer ' + token}
            });
            chatRooms = await res.json();
            log('‚úì ' + chatRooms.length + ' otaq y√ºkl…ôndi');
            renderRooms();
        } catch (err) {
            log('‚úó Otaq y√ºkl…ôm…ô x…ôtasƒ±: ' + err.message);
            console.error('X…ôta:', err);
        }
    }

    async function createChatRoom() {
        if (!token) {
            alert('Login olun!');
            return;
        }

        try {
            log('Yeni chat otaƒüƒ± yaradƒ±lƒ±r...');
            const res = await fetch(API_URL + '/chatRooms/create', {
                method: 'POST',
                headers: {'Authorization': 'Bearer ' + token}
            });
            const newRoom = await res.json();
            chatRooms.push(newRoom);
            log('‚úì Yeni otaq yaradƒ±ldƒ±: #' + newRoom.id);
            renderRooms();
            selectRoom(newRoom);
            alert('Chat otaƒüƒ± yaradƒ±ldƒ±!');
        } catch (err) {
            log('‚úó Otaq yaratma x…ôtasƒ±: ' + err.message);
            alert('X…ôta: ' + err.message);
        }
    }

    async function loadMessages(roomId) {
        if (!token) return;

        try {
            log('Mesajlar y√ºkl…ônir: otaq #' + roomId);
            const res = await fetch(API_URL + '/chat-messages/room/' + roomId, {
                headers: {'Authorization': 'Bearer ' + token}
            });
            messages = await res.json();
            log('‚úì ' + messages.length + ' mesaj y√ºkl…ôndi');
            renderMessages();
        } catch (err) {
            log('‚úó Mesaj y√ºkl…ôm…ô x…ôtasƒ±: ' + err.message);
            console.error('X…ôta:', err);
            messages = [];
            renderMessages();
        }
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message) {
            log('Bo≈ü mesaj g√∂nd…ôril…ô bilm…ôz');
            return;
        }

        if (!selectedRoom) {
            alert('Otaq se√ßin!');
            log('Mesaj g√∂nd…ôrm…ô x…ôtasƒ±: Otaq se√ßilm…ôyib');
            return;
        }

        if (!stompClient || !stompClient.connected) {
            alert('WebSocket baƒülantƒ±sƒ± yoxdur!');
            log('Mesaj g√∂nd…ôrm…ô x…ôtasƒ±: WebSocket baƒülƒ± deyil');
            return;
        }

        try {
            const destination = '/app/chat.send';
            const headers = {};

            const payload = JSON.stringify({
                chatRoomId: selectedRoom.id,
                userId: currentUser.id,
                message: message
            });

            log('üöÄ Mesaj g√∂nd…ôrilir...');
            log('Destination: ' + destination);
            log('Payload: ' + payload);

            stompClient.send(destination, headers, payload);
            log('‚úì Mesaj server…ô g√∂nd…ôrildi (g√∂zl…ônilir...)');

            input.value = '';

            // Fallback: ∆èg…ôr 3 saniy…ô …ôrzind…ô WebSocket-d…ôn g…ôlm…ôzs…ô, REST API-d…ôn yenil…ô
            setTimeout(async function() {
                log('‚è∞ 3 saniy…ô ke√ßdi, mesajlar yenil…ônir...');
                await loadMessages(selectedRoom.id);
            }, 3000);

        } catch (err) {
            log('‚úó Mesaj g√∂nd…ôrm…ô x…ôtasƒ±: ' + err.message);
            console.error('Mesaj g√∂nd…ôrm…ô x…ôtasƒ±:', err);
            alert('Mesaj g√∂nd…ôril…ô bilm…ôdi: ' + err.message);
        }
    }

    async function closeRoom() {
        if (!selectedRoom || !token) return;

        try {
            log('Chat baƒülanƒ±r: #' + selectedRoom.id);
            await fetch(API_URL + '/chatRooms/' + selectedRoom.id + '/close', {
                method: 'PUT',
                headers: {'Authorization': 'Bearer ' + token}
            });
            log('‚úì Chat baƒülandƒ±');
            alert('Chat baƒülandƒ±!');

            if (currentSubscription) {
                currentSubscription.unsubscribe();
                currentSubscription = null;
            }

            selectedRoom = null;
            loadChatRooms();
            document.getElementById('chatPanel').innerHTML = '<div class="empty-state"><div><p style="font-size: 24px; margin-bottom: 10px;">üí¨</p><p>Chat otaƒüƒ± se√ßin</p></div></div>';
        } catch (err) {
            log('‚úó Chat baƒülama x…ôtasƒ±: ' + err.message);
            alert('X…ôta: ' + err.message);
        }
    }

    function selectRoom(room) {
        log('Otaq se√ßildi: #' + room.id);
        selectedRoom = room;
        renderRooms();
        loadMessages(room.id);
        renderChatPanel();

        if (stompClient && stompClient.connected) {
            subscribeToRoom(room.id);
        } else {
            log('WebSocket baƒülƒ± deyil, subscribe edilm…ôdi');
        }
    }

    function renderRooms() {
        const list = document.getElementById('roomsList');

        if (chatRooms.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: #999; padding: 40px 0;">Chat otaƒüƒ± yoxdur</div>';
            return;
        }

        let html = '';
        for (let i = 0; i < chatRooms.length; i++) {
            const room = chatRooms[i];
            const isActive = selectedRoom && selectedRoom.id === room.id;
            html += '<div class="room-item ' + (isActive ? 'active' : '') + '" onclick="selectRoomById(' + room.id + ')">';
            html += '<strong>Otaq #' + room.id + '</strong>';
            html += '<small>User: ' + (room.userFullName || 'N/A') + '</small><br>';
            html += '<small>Status: ' + room.status + '</small>';
            html += '</div>';
        }
        list.innerHTML = html;
    }

    function selectRoomById(roomId) {
        const room = chatRooms.find(function(r) { return r.id === roomId; });
        if (room) selectRoom(room);
    }

    function renderChatPanel() {
        const panel = document.getElementById('chatPanel');
        panel.innerHTML = '<div class="chat-header"><div><h2>Chat Otaƒüƒ± #' + selectedRoom.id + '</h2><small>Status: ' + selectedRoom.status + '</small></div><button class="btn-close" onclick="closeRoom()">‚úï</button></div><div class="messages-area" id="messagesArea"></div><div class="message-input"><div class="message-input-row"><input type="text" id="messageInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." onkeypress="if(event.key===\'Enter\') sendMessage()"><button class="btn-send" onclick="sendMessage()">G√∂nd…ôr</button></div><small style="color: #999; margin-top: 8px; display: block;">WebSocket il…ô real-time mesajla≈üma</small></div>';
        renderMessages();
    }

    function renderMessages() {
        const area = document.getElementById('messagesArea');
        if (!area) return;

        if (messages.length === 0) {
            area.innerHTML = '<div style="text-align: center; color: #999; padding: 80px 0;">Mesaj yoxdur</div>';
            return;
        }

        let html = '';
        for (let i = 0; i < messages.length; i++) {
            const msg = messages[i];
            const isSent = currentUser && msg.senderId === currentUser.id;
            const msgClass = isSent ? 'sent' : 'received';
            const time = new Date(msg.sentAt).toLocaleTimeString('az-AZ');

            html += '<div class="message ' + msgClass + '">';
            html += '<div class="message-bubble">';
            html += '<div class="message-sender">' + msg.senderFullName + '</div>';
            html += '<div>' + msg.message + '</div>';
            html += '<div class="message-time">' + time + '</div>';
            html += '</div></div>';
        }

        area.innerHTML = html;
        area.scrollTop = area.scrollHeight;
    }

    log('Interface y√ºkl…ôndi');
</script>
</body>
</html>